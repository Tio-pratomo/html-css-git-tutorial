---
title: Refactoring Backend
---

### Materi: Pengetahuan & Konsep

Saat ini semua kode backend ada di `server.js` (routes, business logic, config).

Untuk project yang lebih besar, best practice Express adalah memisahkan concerns:

- **Routes**: definisi endpoint & HTTP methods.
- **Controllers**: business logic & request handling.
- **Config**: environment variables & setup.
- **Middleware**: custom middleware (auth, error handling).

Struktur folder yang direkomendasikan:

```text
backend/
├─ src/
│  ├─ routes/
│  │  ├─ auth.routes.js
│  │  └─ books.routes.js
│  ├─ controllers/
│  │  ├─ auth.controller.js
│  │  └─ books.controller.js
│  ├─ middleware/
│  │  └─ auth.middleware.js
│  └─ config/
│     ├─ database.js
│     └─ env.js
├─ .env
├─ server.js (entry point)
└─ package.json
```

Keuntungan struktur ini:

- **Maintainability**: mudah cari & ubah kode spesifik.
- **Scalability**: tambah fitur baru tanpa mengacaukan file lain.
- **Testability**: controller & middleware bisa ditest terpisah.
- **Collaboration**: tim bisa kerja di file berbeda tanpa conflict.

---

## Praktik: Refactoring Step-by-Step

### Langkah 1: Install `dotenv` untuk environment variables

```bash
npm install dotenv
```

### Langkah 2: Buat file `.env` untuk config sensitif

Di root folder `backend/`, buat `.env`:

```txt
PORT=3000
SESSION_SECRET=your-super-secret-key-change-in-production
NODE_ENV=development
FRONTEND_URL=http://localhost:8080
```

Tambahkan `.env` ke `.gitignore` supaya tidak ter-commit:

```txt title=".gitignore"
node_modules/
.env
*.db
```

### Langkah 3: Buat struktur folder `src/`

Buat folder & file berikut:

```bash
mkdir -p src/routes src/controllers src/middleware src/config
touch src/config/env.js
touch src/config/database.js
touch src/middleware/auth.middleware.js
touch src/controllers/auth.controller.js
touch src/controllers/books.controller.js
touch src/routes/auth.routes.js
touch src/routes/books.routes.js
```

### Langkah 4: Setup config – `src/config/env.js`

```js title="src/config/env.js"
require("dotenv").config(); // Load .env

module.exports = {
  PORT: process.env.PORT || 3000,
  SESSION_SECRET: process.env.SESSION_SECRET || "fallback-secret",
  NODE_ENV: process.env.NODE_ENV || "development",
  FRONTEND_URL: process.env.FRONTEND_URL || "http://localhost:8080",
};
```

### Langkah 5: Pindahkan database setup ke `src/config/database.js`

```js title="src/config/database.js"
const Database = require("better-sqlite3");
const path = require("path");

const dbPath = path.join(__dirname, "../../books.db");
const db = new Database(dbPath);

// Create tables
const createBooksTableSQL = `
  CREATE TABLE IF NOT EXISTS books (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    title TEXT NOT NULL,
    author TEXT NOT NULL,
    category TEXT,
    status TEXT DEFAULT 'DRAFT',
    price INTEGER DEFAULT 0,
    stock INTEGER DEFAULT 0
  )
`;

const createUsersTableSQL = `
  CREATE TABLE IF NOT EXISTS users (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    username TEXT UNIQUE NOT NULL,
    password_hash TEXT NOT NULL,
    created_at TEXT DEFAULT (datetime('now'))
  )
`;

db.exec(createBooksTableSQL);
db.exec(createUsersTableSQL);

console.log("✓ Database & tables initialized");

module.exports = db;
```

### Langkah 6: Auth middleware

```js title="src/middleware/auth.middleware.js"
function requireAuth(req, res, next) {
  if (!req.session.userId) {
    return res.status(401).json({ error: "Unauthorized: silakan login" });
  }
  next();
}

module.exports = { requireAuth };
```

### Langkah 7: Auth controller

```js title="src/controllers/auth.controller.js"
const bcrypt = require("bcrypt");
const db = require("../config/database");

async function register(req, res) {
  const { username, password } = req.body;

  if (!username || !password) {
    return res.status(400).json({ error: "Username dan password wajib diisi" });
  }

  if (password.length < 6) {
    return res.status(400).json({ error: "Password minimal 6 karakter" });
  }

  try {
    const saltRounds = 10;
    const passwordHash = await bcrypt.hash(password, saltRounds);

    const insert = db.prepare(`
      INSERT INTO users (username, password_hash)
      VALUES (?, ?)
    `);

    const info = insert.run(username, passwordHash);

    res.status(201).json({
      message: "User berhasil didaftarkan",
      userId: info.lastInsertRowid,
    });
  } catch (err) {
    console.error(err);
    if (err.message.includes("UNIQUE constraint failed")) {
      return res.status(400).json({ error: "Username sudah dipakai" });
    }
    res.status(500).json({ error: "Database error" });
  }
}

async function login(req, res) {
  const { username, password } = req.body;

  if (!username || !password) {
    return res.status(400).json({ error: "Username dan password wajib diisi" });
  }

  try {
    const user = db
      .prepare("SELECT * FROM users WHERE username = ?")
      .get(username);

    if (!user) {
      return res.status(401).json({ error: "Username atau password salah" });
    }

    const isValid = await bcrypt.compare(password, user.password_hash);

    if (!isValid) {
      return res.status(401).json({ error: "Username atau password salah" });
    }

    req.session.userId = user.id;
    req.session.username = user.username;

    res.json({
      message: "Login berhasil",
      user: { id: user.id, username: user.username },
    });
  } catch (err) {
    console.error(err);
    res.status(500).json({ error: "Server error" });
  }
}

function logout(req, res) {
  req.session.destroy((err) => {
    if (err) {
      return res.status(500).json({ error: "Gagal logout" });
    }
    res.json({ message: "Logout berhasil" });
  });
}

function getCurrentUser(req, res) {
  if (!req.session.userId) {
    return res.status(401).json({ error: "Belum login" });
  }

  res.json({
    id: req.session.userId,
    username: req.session.username,
  });
}

module.exports = { register, login, logout, getCurrentUser };
```

### Langkah 8: Books controller

```js title="src/controllers/books.controller.js"
const db = require("../config/database");

function getAllBooks(req, res) {
  try {
    const books = db.prepare("SELECT * FROM books").all();
    res.json(books);
  } catch (err) {
    console.error(err);
    res.status(500).json({ error: "Database error" });
  }
}

function getBookById(req, res) {
  const id = Number(req.params.id);
  try {
    const book = db.prepare("SELECT * FROM books WHERE id = ?").get(id);
    if (!book) {
      return res.status(404).json({ error: "Book not found" });
    }
    res.json(book);
  } catch (err) {
    console.error(err);
    res.status(500).json({ error: "Database error" });
  }
}

function createBook(req, res) {
  const data = req.body;

  if (!data.title || !data.author) {
    return res.status(400).json({ error: "title dan author wajib diisi" });
  }

  try {
    const insert = db.prepare(`
      INSERT INTO books (title, author, category, status, price, stock)
      VALUES (?, ?, ?, ?, ?, ?)
    `);

    const info = insert.run(
      data.title,
      data.author,
      data.category || "",
      data.status || "DRAFT",
      data.price || 0,
      data.stock || 0,
    );

    const newBook = db
      .prepare("SELECT * FROM books WHERE id = ?")
      .get(info.lastInsertRowid);

    res.status(201).json(newBook);
  } catch (err) {
    console.error(err);
    res.status(500).json({ error: "Database error" });
  }
}

function updateBook(req, res) {
  const id = Number(req.params.id);
  const data = req.body;

  try {
    const existing = db.prepare("SELECT * FROM books WHERE id = ?").get(id);
    if (!existing) {
      return res.status(404).json({ error: "Book not found" });
    }

    const update = db.prepare(`
      UPDATE books
      SET title = ?, author = ?, category = ?, status = ?, price = ?, stock = ?
      WHERE id = ?
    `);

    update.run(
      data.title ?? existing.title,
      data.author ?? existing.author,
      data.category ?? existing.category,
      data.status ?? existing.status,
      data.price ?? existing.price,
      data.stock ?? existing.stock,
      id,
    );

    const updated = db.prepare("SELECT * FROM books WHERE id = ?").get(id);
    res.json(updated);
  } catch (err) {
    console.error(err);
    res.status(500).json({ error: "Database error" });
  }
}

function deleteBook(req, res) {
  const id = Number(req.params.id);

  try {
    const existing = db.prepare("SELECT * FROM books WHERE id = ?").get(id);
    if (!existing) {
      return res.status(404).json({ error: "Book not found" });
    }

    db.prepare("DELETE FROM books WHERE id = ?").run(id);
    res.status(204).send();
  } catch (err) {
    console.error(err);
    res.status(500).json({ error: "Database error" });
  }
}

module.exports = {
  getAllBooks,
  getBookById,
  createBook,
  updateBook,
  deleteBook,
};
```

### Langkah 9: Routes

```js title="src/routes/auth.routes.js"
const express = require("express");
const router = express.Router();
const authController = require("../controllers/auth.controller");

router.post("/register", authController.register);
router.post("/login", authController.login);
router.post("/logout", authController.logout);
router.get("/me", authController.getCurrentUser);

module.exports = router;
```

```js title="src/routes/books.routes.js"
const express = require("express");
const router = express.Router();
const booksController = require("../controllers/books.controller");
const { requireAuth } = require("../middleware/auth.middleware");

// Public route
router.get("/", booksController.getAllBooks);
router.get("/:id", booksController.getBookById);

// Protected routes
router.post("/", requireAuth, booksController.createBook);
router.put("/:id", requireAuth, booksController.updateBook);
router.delete("/:id", requireAuth, booksController.deleteBook);

module.exports = router;
```

### Langkah 10: Refactor `server.js`

```js title="server.js"
const express = require("express");
const session = require("express-session");
const cors = require("cors");
const config = require("./src/config/env");
require("./src/config/database"); // Initialize DB

const authRoutes = require("./src/routes/auth.routes");
const booksRoutes = require("./src/routes/books.routes");

const app = express();

// Middleware
app.use(express.json());
app.use(
  cors({
    origin: config.FRONTEND_URL,
    credentials: true,
  }),
);
app.use(
  session({
    secret: config.SESSION_SECRET,
    resave: false,
    saveUninitialized: false,
    cookie: {
      maxAge: 1000 * 60 * 60 * 24,
      httpOnly: true,
    },
  }),
);

// Routes
app.get("/", (req, res) => {
  res.json({ message: "Books API is running (refactored)" });
});

app.use("/api", authRoutes); // /api/login, /api/register, etc.
app.use("/api/books", booksRoutes); // /api/books, /api/books/:id

// Error handling middleware (404)
app.use((req, res) => {
  res.status(404).json({ error: "Route not found" });
});

// Start server
app.listen(config.PORT, () => {
  console.log(`✓ Server running on port ${config.PORT}`);
  console.log(`✓ Environment: ${config.NODE_ENV}`);
});
```

---

## Hasil Akhir

Setelah Sesi 29:

- ✅ Backend terstruktur modular: routes, controllers, middleware, config terpisah.
- ✅ Environment variables dikelola dengan `dotenv` (port, secret, dll.).
- ✅ Entry point `server.js` jadi clean & mudah dibaca (hanya 30-40 baris).
- ✅ Setiap file punya single responsibility (easier to test & maintain).
- ✅ Siap scale: tambah endpoint baru tinggal buat controller & routes baru.

Sesi terakhir (Sesi 30), kita akan deploy project ini ke server production (Render/Railway untuk backend, Netlify/Vercel untuk frontend) dan setup CORS untuk production!
